<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube API OAuth2 Example</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
</head>

<body>
    <button id="loginButton">Login mit Google</button>
    <button id="getCommentsButton">Get Comments</button>
    <button id="deleteButton">Delete Comment</button>
    <div id="output"></div>
    <script>
        const YOUR_CLIENT_ID = '494753670710-1bdnjbifije3cckvbmm29lv9n9okh9qt.apps.googleusercontent.com'; // Ersetze durch deine Client-ID
        //const YOUR_REDIRECT_URI = window.location.origin; // Aktuelle Seite als Redirect-URI
        const YOUR_REDIRECT_URI = 'https://easypx.github.io/yt-comments';
        const YOUR_VIDEO_ID = 'yPJuVLc5Jk4'; // Ersetze durch die Video-ID, von der du Kommentare abrufen möchtest

        // Funktion für den Login und die OAuth2-Umleitung
        function oauth2SignIn() {
            const oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';

            // Generiere einen zufälligen State-Wert, um CSRF zu verhindern
            const state = generateCryptoRandomState();
            localStorage.setItem('state', state);

            // OAuth2-Parameter
            const params = {
                client_id: YOUR_CLIENT_ID,
                redirect_uri: YOUR_REDIRECT_URI,
                response_type: 'token',
                scope: 'https://www.googleapis.com/auth/youtube.force-ssl',
                state: state,
                include_granted_scopes: 'true',
            };

            // Konstruiere die Auth-URL
            const queryString = new URLSearchParams(params).toString();
            const authUrl = `${oauth2Endpoint}?${queryString}`;

            // Umleitung zur Google-Anmeldeseite
            window.location.href = authUrl;
        }

        // Funktion zum Verarbeiten der Redirect-Daten
        function handleRedirect() {
            const fragment = window.location.hash.substring(1); // Entfernt das `#` aus der URL
            const params = new URLSearchParams(fragment);

            if (params.has('access_token')) {
                const accessToken = params.get('access_token');
                const state = params.get('state');

                // Überprüfe den State zur Vermeidung von CSRF-Angriffen
                if (state !== localStorage.getItem('state')) {
                    console.error('State mismatch! CSRF attack detected.');
                    return;
                }

                // Speichere den Access Token im LocalStorage
                localStorage.setItem('access_token', accessToken);
                console.log('Access Token gespeichert:', accessToken);

                // Entferne den Fragment-Teil aus der URL
                window.location.hash = '';

                // Rufe die YouTube API auf
                //fetchComments(accessToken);
            }
        }

        // Funktion zum Abrufen von Kommentaren
        function fetchComments() {
            const accessToken = localStorage.getItem("access_token");
            const videoId = prompt("Gib die Video-ID ein:"); // Gib die ID des Videos an

            fetch(`https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}`, {
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API-Fehler: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayComments(data);
                })
                .catch(error => console.error('Fehler bei API-Aufruf:', error));
        }

        /// Funktion zum Anzeigen der Kommentare mit IDs
        function displayComments(data) {
            const output = document.getElementById('output');
            output.innerHTML = ''; // Vorherigen Inhalt löschen

            if (data.items) {
                data.items.forEach(item => {
                    const comment = item.snippet.topLevelComment.snippet.textDisplay;
                    const author = item.snippet.topLevelComment.snippet.authorDisplayName;
                    const commentId = item.snippet.topLevelComment.id; // Kommentar-ID

                    const commentDiv = document.createElement('div');
                    commentDiv.innerHTML = `
                <p><strong>${author}:</strong> ${comment}</p>
                <p><em>Kommentar-ID:</em> ${commentId}</p>
                <hr>
            `;
                    output.appendChild(commentDiv);
                });
            } else {
                output.textContent = 'Keine Kommentare gefunden.';
            }
        }

        // Funktion zum Löschen von Kommentaren
        function deleteComment() {
            const accessToken = localStorage.getItem("access_token");
            const commentId = prompt("Gib die Kommentar-ID ein:"); // Gib die ID des Kommentars an

            if (!commentId) {
                console.error("Keine Kommentar-ID angegeben.");
                return;
            }

            fetch(`https://www.googleapis.com/youtube/v3/comments?id=${commentId}`, {
                method: "DELETE",
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (response.status === 204) {
                        // Kommentar erfolgreich gelöscht
                        console.log("Kommentar erfolgreich gelöscht!");
                    } else {
                        // Fehler behandeln, wenn der Status nicht 204 ist
                        return response.json().then(err => {
                            throw new Error(`API-Fehler: ${response.status} - ${err.error.message}`);
                        });
                    }
                })
                .catch(error => console.error('Fehler bei API-Aufruf:', error));
        }


        // Generiere einen zufälligen State-Wert
        function generateCryptoRandomState() {
            const randomValues = new Uint8Array(16); // 16 zufällige Bytes
            window.crypto.getRandomValues(randomValues);
            return Array.from(randomValues, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        // Ereignislistener für Buttons
        document.getElementById('loginButton').addEventListener('click', oauth2SignIn);
        document.getElementById('getCommentsButton').addEventListener('click', fetchComments);
        document.getElementById('deleteButton').addEventListener('click', deleteComment);

        // Handle Redirect beim Laden der Seite
        window.onload = handleRedirect;
    </script>
</body>

</html>